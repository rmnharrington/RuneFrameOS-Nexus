# OpenTelemetry Network Policy Configuration
# Security Level: SECURE
# Compliance: NIST CSF, SOC 2

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: otel-agent-network-policy
  namespace: opentelemetry
  labels:
    app: opentelemetry-agent
    security-level: secure
    compliance: nist-csf
spec:
  podSelector:
    matchLabels:
      app: otel-agent
  policyTypes:
  - Ingress
  - Egress
  
  # Ingress Rules - Allow OTLP traffic from applications
  ingress:
  # Allow OTLP gRPC traffic from application pods
  - from:
    - namespaceSelector:
        matchLabels:
          observability: true
    ports:
    - protocol: TCP
      port: 4317
      description: "OTLP gRPC receiver"
  # Allow OTLP HTTP traffic from application pods
  - from:
    - namespaceSelector:
        matchLabels:
          observability: true
    ports:
    - protocol: TCP
      port: 4318
      description: "OTLP HTTP receiver"
  # Allow metrics endpoint for monitoring
  - from:
    - namespaceSelector:
        matchLabels:
          name: observability
    ports:
    - protocol: TCP
      port: 8888
      description: "Metrics endpoint"
  
  # Egress Rules - Allow communication to gateway
  egress:
  # Allow communication to OTel Gateway
  - to:
    - namespaceSelector:
        matchLabels:
          name: opentelemetry
    ports:
    - protocol: TCP
      port: 4317
      description: "OTLP gRPC to gateway"
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
      description: "DNS resolution"
  # Allow NTP for time synchronization
  - to: []
    ports:
    - protocol: UDP
      port: 123
      description: "NTP time sync"
---
# Gateway Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: otel-gateway-network-policy
  namespace: opentelemetry
  labels:
    app: opentelemetry-gateway
    security-level: secure
    compliance: nist-csf
spec:
  podSelector:
    matchLabels:
      app: otel-gateway
  policyTypes:
  - Ingress
  - Egress
  
  # Ingress Rules - Allow traffic from agents
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: opentelemetry
    ports:
    - protocol: TCP
      port: 4317
      description: "OTLP gRPC from agents"
  
  # Egress Rules - Allow communication to backends
  egress:
  # Allow communication to Elasticsearch
  - to:
    - namespaceSelector:
        matchLabels:
          name: observability
    ports:
    - protocol: TCP
      port: 9200
      description: "Elasticsearch HTTP"
    - protocol: TCP
      port: 9300
      description: "Elasticsearch transport"
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
      description: "DNS resolution"


